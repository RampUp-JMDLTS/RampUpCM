---
- name: Configuramos el repositorio de Kubernetes
  yum_repository:
    name: kubernetes
    description: Repositorio oficial de Kubernetes
    baseurl: https://pkgs.k8s.io/core:/stable:/v1.30/rpm/
    enabled: yes
    gpgcheck: yes
    repo_gpgcheck: yes
    gpgkey: https://pkgs.k8s.io/core:/stable:/v1.30/rpm/repodata/repomd.xml.key

- name: Update apt
  yum:
    update_cache: yes

- name: Installing required packages
  yum:
    name: "{{ item }}"
    state: present
  with_items:
    - kubelet
    - kubeadm
    - kubectl

- name: Load modules for IP Forwarding
  shell: | 
          modprobe overlay
          modprobe br_netfilter

- name: Config for iptables
  blockinfile:
    path: /etc/sysctl.d/kubernetes.conf
    create: yes
    block: |
            net.bridge.bridge-nf-call-ip6tables = 1
            net.bridge.bridge-nf-call-iptables = 1
            net.ipv4.ip_forward = 1

- name: make all IPconfig persistent
  shell: echo br_netfilter | tee /etc/modules-load.d/kubernetes.conf

- name: configure sysctl
  shell: sysctl --system

- name: able Kubernetes service
  systemd:
    name: kubelet
    state: started
    enabled: yes
    masked: no