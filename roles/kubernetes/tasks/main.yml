---
- name: Configuramos el repositorio de Kubernetes
  yum_repository:
    name: Kubernetes
    description: Repositorio oficial de Kubernetes
    baseurl: https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
    enabled: yes
    gpgcheck: yes
    repo_gpgcheck: yes
    gpgkey: https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
    exclude: kubelet kubeadm kubectl
  become: yes

- name: Update apt
  yum:
    update_cache: yes

- name: Install Kubelet
  yum:
    name: kubelet
    state: present
    disable_excludes: Kubernetes
  become: yes

- name: Install Kubectl
  yum:
    name: kubectl
    state: present
    disable_excludes: Kubernetes
  become: yes

- name: Install kubeadm
  yum:
    name: kubeadm
    state: present
    disable_excludes: kubernetes
  become: yes

- name: Load modules for IP Forwarding
  shell: | 
          modprobe overlay
          modprobe br_netfilter

- name: Config for iptables
  blockinfile:
    path: /etc/sysctl.d/kubernetes.conf
    create: yes
    block: |
            net.bridge.bridge-nf-call-ip6tables = 1
            net.bridge.bridge-nf-call-iptables = 1
            net.ipv4.ip_forward = 1

- name: make all IPconfig persistent
  shell: echo br_netfilter | tee /etc/modules-load.d/kubernetes.conf

- name: configure sysctl
  shell: sysctl --system

